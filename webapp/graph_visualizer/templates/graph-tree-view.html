<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    (function () {
        let nodeArray = [];
        let nodeListItems = new Map();
        let selectedNode = null;
        let expandedNodes = new Set();

        const buildTree = (nodes, links) => {
            nodeArray = nodes.map(n => ({...n, children: [], expanded: false}));
            const nodeMap = new Map(nodeArray.map(n => [n.node_id, n]));

            // Build child lists
            links.forEach(link => {
                const parent = nodeMap.get(link.source.node_id);
                const child = nodeMap.get(link.target.node_id);
                if (parent && child && !parent.children.includes(child)) parent.children.push(child);
            });

            // Pick a single root
            const targets = new Set(links.map(l => l.target.node_id));
            let root = nodeArray.find(n => !targets.has(n.node_id)) || nodeArray[0];
            return [root]; // always return a single-element array
        };

        const findNodePath = (node, targetId, path = [], visited = new Set()) => {
            if (!node || visited.has(node.node_id)) return null;
            visited.add(node.node_id);
            if (node.node_id === targetId) return [...path, node];
            for (const child of node.children) {
                const result = findNodePath(child, targetId, [...path, node], visited);
                if (result) return result;
            }
            return null;
        };

        const renderNode = (container, node, visited = new Set()) => {
            if (!node) return;

            const li = container.append("li")
                .style("margin", "4px 0")
                .style("padding", "4px 12px")
                .style("border-radius", "6px")
                .style("background-color", selectedNode === node.node_id ? "#ffe0b2" : "#f9fafb")
                .style("box-shadow", selectedNode === node.node_id ? "0 4px 12px rgba(255,138,0,0.3)" : "0 2px 6px rgba(0,0,0,0.08)")
                .style("user-select", "none")
                .style("cursor", node.children.length > 0 ? "pointer" : "default");

            li.append("span")
                .text(node.children.length > 0 ? (expandedNodes.has(node.node_id) ? "âˆ’ ğŸ“‚ " : "+ ğŸ“ ") : "  ğŸ“„ ")
                .style("margin-right", "6px")
                .style("color", node.children.length > 0 ? "#1976d2" : "#757575")
                .style("font-weight", "700");

            li.append("span")
                .text(`ID: ${node.node_id}`)
                .style("font-size", "14px")
                .style("color", "#33475b")
                .style("font-weight", "600");

            if (!nodeListItems.has(node.node_id)) nodeListItems.set(node.node_id, new Set());
            nodeListItems.get(node.node_id).add(li);

            if (node.children.length > 0) {
                let ul;
                const renderChildren = () => {
                    if (!ul) {
                        ul = container.append("ul")
                            .style("list-style", "none")
                            .style("padding-left", "2rem")
                            .style("margin-left", "0.4rem")
                            .style("border-left", "2px solid #d0d7de");

                        const newVisited = new Set(visited);
                        newVisited.add(node.node_id);

                        node.children.forEach(child => {
                            if (!visited.has(child.node_id)) {
                                renderNode(ul, child, newVisited);
                            } else {
                                ul.append("li")
                                    .text(`â†º Cycle to ID: ${child.node_id}`)
                                    .style("color", "red")
                                    .style("font-style", "italic");
                            }
                        });
                    }
                    ul.style("display", expandedNodes.has(node.node_id) ? "block" : "none");
                };

                li.on("click", (event) => {
                    event.stopPropagation();
                    if (expandedNodes.has(node.node_id)) {
                        expandedNodes.delete(node.node_id);
                    } else {
                        expandedNodes.add(node.node_id);
                    }
                    renderTree(); // rerender lazily
                    emitTreeElementSelect(node);
                });

                if (expandedNodes.has(node.node_id)) renderChildren();
            } else {
                li.on("click", (event) => {
                    event.stopPropagation();
                    emitTreeElementSelect(node);
                });
            }
        };

        const renderTree = () => {
            d3.select("#tree-container").html("");
            nodeListItems.clear();
            const roots = buildTree(window.GraphMain.nodes, window.GraphMain.links);
            const container = d3.select("#tree-container").append("ul")
                .style("list-style", "none")
                .style("padding", "0")
                .style("margin", "0");

            roots.forEach(root => {
                renderNode(container, root);
            });
        };

        const autoExpandPath = (targetId) => {
            const roots = buildTree(window.GraphMain.nodes, window.GraphMain.links);
            roots.forEach(root => {
                const path = findNodePath(root, targetId) || [];
                path.forEach(n => expandedNodes.add(n.node_id));
            });
        };

        const emitTreeElementSelect = (node) => {
            if (selectedNode !== node.node_id) window.GraphMain.selectNode(node, true);
        };

        window.addEventListener("GraphNodeSelected", (e) => {
            const selected = e.detail.selectedNode;
            if (!selected) return;
            selectedNode = selected.node_id;
            autoExpandPath(selected.node_id);
            renderTree();

            setTimeout(() => {
                if (nodeListItems.has(selected.node_id)) {
                    for (const li of nodeListItems.get(selected.node_id)) {
                        li.node().scrollIntoView({behavior: "smooth", block: "center"});
                    }
                }
            }, 50);
        });

        document.addEventListener("GraphMainReady", () => {
            renderTree();
        });
    })();
</script>
