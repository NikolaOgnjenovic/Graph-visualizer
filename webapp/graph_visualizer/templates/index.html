<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Graph Visualizer</title>
    <link rel="stylesheet" href="{% static 'style.css' %}"/>
</head>
<body>
    <div class="header">
        <span class="header-title">Graph Visualizer</span>
        <form class="upload-form" method="post" enctype="multipart/form-data" action="{% url 'visualize' %}">
            {% csrf_token %}
            <input type="file" name="graph_file" accept=".json, .xml, .csv" />
            <button type="submit" class="btn btn-primary">Load File</button>
        </form>
    </div>

    <!-- Workspace Tabs -->
    <div class="workspace-tabs">
        {% for workspace in all_workspaces %}
            <div class="tab {% if workspace.workspace_id == current_workspace_id %}active{% endif %}" 
                 onclick="switchWorkspace('{{ workspace.workspace_id }}')">
                <span class="tab-name" 
                      id="tab-name-{{ workspace.workspace_id }}">
                    {{ workspace.name }}
                </span>                      
                <button class="tab-rename" 
                        onclick="event.stopPropagation(); startRenaming('{{ workspace.workspace_id }}', '{{ workspace.name }}')">
                    ✎
                </button>
                <button class="tab-close" 
                        onclick="event.stopPropagation(); closeWorkspace('{{ workspace.workspace_id }}')">
                    ×
                </button>
            </div>
        {% endfor %}
                
        <!-- Plugin Selectors -->
        <div class="plugin-selectors">
            <div class="plugin-selector">
                <label for="visualizer-select">Visualizer:</label>
                <select id="visualizer-select" onchange="changeVisualizer(this.value)">
                    {% for plugin in visualizer_plugins %}
                        <option value="{{ plugin.identifier }}" 
                                {% if current_workspace and current_workspace.visualizer_plugin.identifier == plugin.identifier %}selected{% endif %}>
                            {{ plugin.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="plugin-selector">
                <label for="datasource-select">Available Data Sources:</label>
                <select id="datasource-select">
                    {% for plugin in datasource_plugins %}
                        <option value="{{ plugin.identifier }}" 
                                {% if current_workspace and current_workspace.datasource_plugin.identifier == plugin.identifier %}selected{% endif %}>
                            {{ plugin.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Add Search Modal -->
    <div id="add-search-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddSearch()">&times;</span>
            <h3>Add Search</h3>
            <input type="text" id="search-query" placeholder="Enter search text..." class="modal-input">
            <div class="modal-actions">
                <button onclick="addSearch()" class="btn-primary">Add Search</button>
                <button onclick="closeAddSearch()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Filter Modal -->
    <div id="add-filter-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddFilter()">&times;</span>
            <h3>Add Filter</h3>
            <div class="filter-inputs">
                <input type="text" id="filter-attribute" placeholder="Attribute name" class="modal-input">
                <select id="filter-operator" class="modal-input">
                    <option value="==">== (equals)</option>
                    <option value="!=">!= (not equals)</option>
                    <option value=">">> (greater than)</option>
                    <option value="<">< (less than)</option>
                    <option value=">=">>= (greater or equal)</option>
                    <option value="<="><= (less or equal)</option>
                </select>
                <input type="text" id="filter-value" placeholder="Value" class="modal-input">
            </div>
            <div class="modal-actions">
                <button onclick="addFilter()" class="btn-primary">Add Filter</button>
                <button onclick="closeAddFilter()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <main class="content">
              <!-- Error Display Section -->
        {% if errors %}
        <div class="error-notification">
            <div class="error-header">
                <h4>⚠️ Filter Application Errors</h4>
                <button class="error-close" onclick="closeErrorNotification()">×</button>
            </div>
            <div class="error-list">
                {% for error in errors %}
                <div class="error-item">
                    <span class="error-icon">❌</span>
                    <span class="error-text">{{ error }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <div style="position: relative; width: 100%; height: 100%;">
            <svg id="main-view" style="width: 100%;height: 100%"></svg>

            <div id="zoom-controls" style="
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                z-index: 20;">
                <button id="zoom-in">+</button>
                <button id="zoom-out">−</button>
                <div id="tooltip"></div>
            </div>
        </div>

        <!-- Search and Filter Panel -->
        <div class="search-filter-panel">
            <div class="search-filter-header">
                <h4>Search & Filters</h4>
            </div>
            
            <!-- Search List -->
            <div class="condition-list">
                <div class="condition-header">
                    <span>Searches</span>
                    <button class="btn-add-condition" onclick="showAddSearch()">+ Search</button>
                </div>
                <div id="search-list">
                    {% for search in current_workspace.searches %}
                    <div class="condition-item">
                        <span class="condition-text">Search: "{{ search.query }}"</span>
                        <button class="condition-remove" onclick="removeSearch('{{ forloop.counter0 }}')">×</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Filter List -->
            <div class="condition-list">
                <div class="condition-header">
                    <span>Filters</span>
                    <button class="btn-add-condition" onclick="showAddFilter()">+ Filter</button>
                </div>
                <div id="filter-list">
                    {% for filter in current_workspace.filters %}
                    <div class="condition-item">
                        <span class="condition-text">Filter: {{ filter.attribute }} {{ filter.operator }} {{ filter.value }}</span>
                        <button class="condition-remove" onclick="removeFilter('{{ forloop.counter0 }}')">×</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
        {% if main_graph_view %}
            {{ main_graph_view|safe }}
        <aside class="fixed-minimap-sidebar">
          <div class="sidebar-content">
            <div class="view-box tree-box" id="tree-container">
              {% if tree_view %}
                {{ tree_view|safe }}
              {% else %}
                <div class="placeholder">Tree view will appear here</div>
              {% endif %}
            </div>

            <div class="view-box bird-box">
              <div class="minimap-container">
                <svg id="miniMapSvg"></svg>
              </div>
              {% if bird_view %}
                {{ bird_view|safe }}
              {% else %}
                <div class="placeholder">Bird view will appear here</div>
              {% endif %}
            </div>
          </div>
        </aside>

        {% else %}
            <div class="placeholder">Upload a JSON file to visualize the graph.</div>
        {% endif %}

    <!-- CLI Terminal -->
    <div class="cli-terminal-wrapper">
        <div class="cli-resize-handle"></div>
        <div class="cli-terminal" id="cli-terminal">
            <div class="cli-terminal-header">
                <span>Graph Visualizer CLI</span>
                <button class="cli-toggle-btn" onclick="toggleCLI()">−</button>
            </div>
            <div class="cli-terminal-content" id="cli-terminal-content">
                <div class="cli-output" id="cli-output">
                    <div class="cli-message">Type 'help' for available commands</div>
                </div>
                <div class="cli-input-line">
                    <span class="cli-prompt">graph_cli&gt;</span>
                    <input type="text" class="cli-input" id="cli-input" 
                           placeholder="Enter command..." autocomplete="off"
                           onkeydown="handleCLICommand(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for CLI commands -->
    <form id="cli-command-form" method="post" action="{% url 'execute_command' %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="cli_command" id="cli-command-input">
    </form>

    <div id="cli-error-notification" class="error-notification {% if not request.session.cli_error %}hidden{% endif %}">
        <div class="error-header">
            <h4>⚠️ CLI Command Error</h4>
            <button class="error-close" onclick="closeCLIErrorNotification()">×</button>
        </div>
        <div class="error-list">
            <div class="error-item">
                <span class="error-icon">❌</span>
                <span class="error-text">{{ request.session.cli_error }}</span>
            </div>
        </div>
    </div>

    </main>

    <script>
        function closeWorkspace(workspaceId) {
            if (confirm('Are you sure you want to close this workspace?')) {
                window.location.href = `/workspace/${workspaceId}/close/`;
            }
        }
        
        function switchWorkspace(workspaceId) {
            window.location.href = `/workspace/${workspaceId}/switch/`;
        }
        
        function startRenaming(workspaceId, currentName) {
            const tabName = document.getElementById(`tab-name-${workspaceId}`);
            tabName.innerHTML = `
                <input type="text" value="${currentName}" 
                       onblur="finishRenaming('${workspaceId}', this.value)"
                       onkeypress="if(event.keyCode===13) this.blur()"
                       style="width: 120px; padding: 2px;" autofocus>
            `;
            tabName.querySelector('input').select();
        }
        
        function finishRenaming(workspaceId, newName) {
            if (newName.trim()) {
                fetch(`/workspace/${workspaceId}/rename/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `name=${encodeURIComponent(newName)}`
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          document.getElementById(`tab-name-${workspaceId}`).textContent = newName;
                      }
                  });
            } else {
                location.reload();
            }
        }
        
        function changeVisualizer(visualizerId) {
            window.location.href = `/visualizer-plugin/${visualizerId}/`;
        }
        
        function changeDatasource(datasourceId) {
            window.location.href = `/datasource-plugin/${datasourceId}/`;
        }
        
        // Search and Filter Functions
        function showAddSearch() {
            document.getElementById('add-search-modal').style.display = 'block';
            document.getElementById('search-query').value = '';
            document.getElementById('search-query').focus();
        }
        
        function closeAddSearch() {
            document.getElementById('add-search-modal').style.display = 'none';
        }
        
        function showAddFilter() {
            document.getElementById('add-filter-modal').style.display = 'block';
            document.getElementById('filter-attribute').value = '';
            document.getElementById('filter-value').value = '';
            document.getElementById('filter-attribute').focus();
        }
        
        function closeAddFilter() {
            document.getElementById('add-filter-modal').style.display = 'none';
        }
        
        function addSearch() {
            const query = document.getElementById('search-query').value.trim();
            if (query) {
                fetch('/workspace/add_search/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `query=${encodeURIComponent(query)}`
                }).then(response => {
                    if (response.ok) {
                        closeAddSearch();
                        applyFilters(); // Apply immediately after adding
                    }
                });
            }
        }
        
        function addFilter() {
            const attribute = document.getElementById('filter-attribute').value.trim();
            const operator = document.getElementById('filter-operator').value;
            const value = document.getElementById('filter-value').value.trim();
            
            if (attribute && value) {
                fetch('/workspace/add_filter/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `attribute=${encodeURIComponent(attribute)}&operator=${encodeURIComponent(operator)}&value=${encodeURIComponent(value)}`
                }).then(response => {
                    if (response.ok) {
                        closeAddFilter();
                        applyFilters(); // Apply immediately after adding
                    }
                });
            }
        }
        
        function removeSearch(index) {
            fetch('/workspace/remove_search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `index=${index}`
            }).then(response => {
                if (response.ok) {
                    applyFilters(); // Apply immediately after removal
                }
            });
        }
        
        function removeFilter(index) {
            fetch('/workspace/remove_filter/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `index=${index}`
            }).then(response => {
                if (response.ok) {
                    applyFilters(); // Apply immediately after removal
                }
            });
        }
        
        function applyFilters() {
            // This will trigger a page reload with filters applied
            window.location.reload();
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const searchModal = document.getElementById('add-search-modal');
            const filterModal = document.getElementById('add-filter-modal');
            
            if (event.target === searchModal) {
                closeAddSearch();
            }
            if (event.target === filterModal) {
                closeAddFilter();
            }
        }

        // CLI functionality
        let cliExpanded = true;
        const cliTerminal = document.getElementById('cli-terminal');
        const cliContent = document.getElementById('cli-terminal-content');
        const cliOutput = document.getElementById('cli-output');
        const cliInput = document.getElementById('cli-input');
        const resizeHandle = document.querySelector('.cli-resize-handle');

        function toggleCLI() {
            cliExpanded = !cliExpanded;
            if (cliExpanded) {
                cliContent.style.display = 'block';
                cliTerminal.style.height = '300px';
                cliTerminal.classList.remove('collapsed');
                document.querySelector('.cli-toggle-btn').textContent = '−';
            } else {
                cliContent.style.display = 'none';
                cliTerminal.style.height = '40px';
                cliTerminal.classList.add('collapsed');
                document.querySelector('.cli-toggle-btn').textContent = '+';
            }
            scrollCLIToBottom();
        }

        function handleCLICommand(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const command = cliInput.value.trim();
                
                if (!command) return;
                
                // Add command to output
                addCLIOutput(`graph_cli&gt; ${command}`, 'command');
                
                // Handle local commands
                if (command.toLowerCase() === 'clear') {
                    clearCLI();
                } else if (command.toLowerCase() === 'help') {
                    showCLIHelp();
                } else {
                    // Send command to server
                    submitCLICommand(command);
                }
                
                cliInput.value = '';
                scrollCLIToBottom();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                // Maybe implementing command history
            }
        }

        function addCLIOutput(text, type = 'output') {
            const outputLine = document.createElement('div');
            outputLine.className = `cli-output-line ${type}`;
            outputLine.textContent = text;
            cliOutput.appendChild(outputLine);
        }

        function clearCLI() {
            cliOutput.innerHTML = '';
            addCLIOutput('Terminal cleared', 'system');
        }

        function showCLIHelp() {
            const helpText = [
                'Available commands:',
                '  clear - Clear terminal',
                '  help - Show this help',
                'Graph commands:',
                '  create node --id=X --property Name=Value',
                '  create edge node1 node2 [--property Name=Value]',
                '  edit node --id=X --property Name=Value',
                '  edit edge node1 node2 --property Name=Value',
                '  delete node --id=X',
                '  delete edge node1 node2',
                '  filter condition (e.g., Age>30 && Name=John)',
                '  search query',
                '  clear graph'
            ];
            
            helpText.forEach(line => addCLIOutput(line, 'help'));
        }

        function submitCLICommand(command) {
            const form = document.getElementById('cli-command-form');
            const input = document.getElementById('cli-command-input');
            input.value = command;
            form.submit();
        }

        function scrollCLIToBottom() {
            cliOutput.scrollTop = cliOutput.scrollHeight;
        }

        function closeCLIErrorNotification() {
            const cliErrorNotification = document.getElementById('cli-error-notification');
            if (cliErrorNotification) {
                cliErrorNotification.style.display = 'none';
            }
        }

        let isResizing = false;

        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        });

        function handleResize(e) {
            if (!isResizing) return;
            
            const newHeight = window.innerHeight - e.clientY;
            const minHeight = 100;
            const maxHeight = window.innerHeight - 100;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                cliTerminal.style.height = newHeight + 'px';
                cliExpanded = true;
                cliTerminal.classList.remove('collapsed');
                document.querySelector('.cli-toggle-btn').textContent = '−';
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }
    </script>
</body>
</html>