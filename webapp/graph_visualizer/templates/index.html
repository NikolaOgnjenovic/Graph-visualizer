<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Graph Visualizer</title>
    <link rel="stylesheet" href="{% static 'style.css' %}"/>
</head>
<body>
    <div class="header">
        <span class="header-title">Graph Visualizer</span>
        <form class="upload-form" method="post" enctype="multipart/form-data" action="{% url 'visualize' %}">
            {% csrf_token %}
            <input type="file" name="graph_file" accept=".json, .xml" />
            <button type="submit" class="btn btn-primary">Load File</button>
        </form>
    </div>

    <!-- Workspace Tabs -->
    <div class="workspace-tabs">
        {% for workspace in all_workspaces %}
            <div class="tab {% if workspace.workspace_id == current_workspace_id %}active{% endif %}" 
                 onclick="switchWorkspace('{{ workspace.workspace_id }}')">
                <span class="tab-name" 
                      id="tab-name-{{ workspace.workspace_id }}">
                    {{ workspace.name }}
                </span>                      
                <button class="tab-rename" 
                        onclick="event.stopPropagation(); startRenaming('{{ workspace.workspace_id }}', '{{ workspace.name }}')">
                    ✎
                </button>
                <button class="tab-close" 
                        onclick="event.stopPropagation(); closeWorkspace('{{ workspace.workspace_id }}')">
                    ×
                </button>
            </div>
        {% endfor %}
                
        <!-- Plugin Selectors -->
        <div class="plugin-selectors">
            <div class="plugin-selector">
                <label for="visualizer-select">Visualizer:</label>
                <select id="visualizer-select" onchange="changeVisualizer(this.value)">
                    {% for plugin in visualizer_plugins %}
                        <option value="{{ plugin.identifier }}" 
                                {% if current_workspace and current_workspace.visualizer_plugin.identifier == plugin.identifier %}selected{% endif %}>
                            {{ plugin.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="plugin-selector">
                <label for="datasource-select">Available Data Sources:</label>
                <select id="datasource-select">
                    {% for plugin in datasource_plugins %}
                        <option value="{{ plugin.identifier }}" 
                                {% if current_workspace and current_workspace.datasource_plugin.identifier == plugin.identifier %}selected{% endif %}>
                            {{ plugin.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <main class="content">
        <div style="position: relative; width: 100%; height: 100%;">
            <svg id="main-view" style="width: 100%;height: 100%"></svg>

            <div id="zoom-controls" style="
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                z-index: 20;">
                <button id="zoom-in">+</button>
                <button id="zoom-out">−</button>
                <div id="tooltip"></div>
            </div>
        </div>

        {% if main_graph_view %}
            {{ main_graph_view|safe }}
        <aside class="fixed-minimap-sidebar">
          <div class="sidebar-content">
            <div class="view-box tree-box" id="tree-container">
              {% if tree_view %}
                {{ tree_view|safe }}
              {% else %}
                <div class="placeholder">Tree view will appear here</div>
              {% endif %}
            </div>

            <div class="view-box bird-box">
              <div class="minimap-container">
                <svg id="miniMapSvg"></svg>
              </div>
              {% if bird_view %}
                {{ bird_view|safe }}
              {% else %}
                <div class="placeholder">Bird view will appear here</div>
              {% endif %}
            </div>
          </div>
        </aside>

        {% else %}
            <div class="placeholder">Upload a JSON file to visualize the graph.</div>
        {% endif %}
    </main>

    <script>
        function closeWorkspace(workspaceId) {
            if (confirm('Are you sure you want to close this workspace?')) {
                window.location.href = `/workspace/${workspaceId}/close/`;
            }
        }
        
        function switchWorkspace(workspaceId) {
            window.location.href = `/workspace/${workspaceId}/switch/`;
        }
        
        function startRenaming(workspaceId, currentName) {
            const tabName = document.getElementById(`tab-name-${workspaceId}`);
            tabName.innerHTML = `
                <input type="text" value="${currentName}" 
                       onblur="finishRenaming('${workspaceId}', this.value)"
                       onkeypress="if(event.keyCode===13) this.blur()"
                       style="width: 120px; padding: 2px;" autofocus>
            `;
            tabName.querySelector('input').select();
        }
        
        function finishRenaming(workspaceId, newName) {
            if (newName.trim()) {
                // AJAX call to rename workspace
                fetch(`/workspace/${workspaceId}/rename/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `name=${encodeURIComponent(newName)}`
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          document.getElementById(`tab-name-${workspaceId}`).textContent = newName;
                      }
                  });
            } else {
                // Reload to get original name
                location.reload();
            }
        }
        
        function changeVisualizer(visualizerId) {
            window.location.href = `/visualizer-plugin/${visualizerId}/`;
        }
        
        function changeDatasource(datasourceId) {
            window.location.href = `/datasource-plugin/${datasourceId}/`;
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>